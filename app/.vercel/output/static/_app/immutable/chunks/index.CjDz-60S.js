import{O as Te,d as B,i as H,f as x,m as N,o as se,h as Tt,_ as wt,j as xt,k as ae,l as Et,n as kt,p as ce,q as Ye}from"./client.C1mLzEnz.js";function It(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function At(){const e=It();if(e.__xstate__)return e.__xstate__}const $t=e=>{if(typeof window>"u")return;const t=At();t&&t.register(e)};class qe{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const n={value:t,next:null};if(this._current){this._last.next=n,this._last=n;return}this._current=n,this._last=n,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const Fe=".",Ot="",Ve="",Rt="#",Mt="*",Ze="xstate.init",qt="xstate.error",G="xstate.stop";function Ct(e,t){return{type:`xstate.after.${e}.${t}`}}function ge(e,t){return{type:`xstate.done.state.${e}`,output:t}}function jt(e,t){return{type:`xstate.done.actor.${e}`,output:t,actorId:e}}function Ne(e,t){return{type:`xstate.error.actor.${e}`,error:t,actorId:e}}function Qe(e){return{type:Ze,input:e}}function T(e){setTimeout(()=>{throw e})}const Dt=typeof Symbol=="function"&&Symbol.observable||"@@observable";function et(e,t){const n=Ce(e),s=Ce(t);return typeof s=="string"?typeof n=="string"?s===n:!1:typeof n=="string"?n in s:Object.keys(n).every(i=>i in s?et(n[i],s[i]):!1)}function we(e){if(nt(e))return e;const t=[];let n="";for(let s=0;s<e.length;s++){switch(e.charCodeAt(s)){case 92:n+=e[s+1],s++;continue;case 46:t.push(n),n="";continue}n+=e[s]}return t.push(n),t}function Ce(e){if(yn(e))return e.value;if(typeof e!="string")return e;const t=we(e);return Lt(t)}function Lt(e){if(e.length===1)return e[0];const t={};let n=t;for(let s=0;s<e.length-1;s++)if(s===e.length-2)n[e[s]]=e[s+1];else{const i=n;n={},i[e[s]]=n}return t}function je(e,t){const n={},s=Object.keys(e);for(let i=0;i<s.length;i++){const r=s[i];n[r]=t(e[r],r,e,i)}return n}function tt(e){return nt(e)?e:[e]}function w(e){return e===void 0?[]:tt(e)}function me(e,t,n,s){return typeof e=="function"?e({context:t,event:n,self:s}):e}function nt(e){return Array.isArray(e)}function Ut(e){return e.type.startsWith("xstate.error.actor")}function R(e){return tt(e).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function st(e){if(!(e===void 0||e===Ot))return w(e)}function ve(e,t,n){var r,o,a;const s=typeof e=="object",i=s?e:void 0;return{next:(r=s?e.next:e)==null?void 0:r.bind(i),error:(o=s?e.error:t)==null?void 0:o.bind(i),complete:(a=s?e.complete:n)==null?void 0:a.bind(i)}}function De(e,t){return`${t}.${e}`}function xe(e,t){const n=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!n)return e.implementations.actors[t];const[,s,i]=n,o=e.getStateNodeById(i).config.invoke;return(Array.isArray(o)?o[s]:o).src}function Le(e,t){return`${e.sessionId}.${t}`}let Jt=0;function Pt(e,t){const n=new Map,s=new Map,i=new WeakMap,r=new Set,o={},{clock:a,logger:c}=t,u={schedule:(f,h,p,y,g=Math.random().toString(36).slice(2))=>{const S={source:f,target:h,event:p,delay:y,id:g,startedAt:Date.now()},b=Le(f,g);d._snapshot._scheduledEvents[b]=S;const bt=a.setTimeout(()=>{delete o[b],delete d._snapshot._scheduledEvents[b],d._relay(f,h,p)},y);o[b]=bt},cancel:(f,h)=>{const p=Le(f,h),y=o[p];delete o[p],delete d._snapshot._scheduledEvents[p],y!==void 0&&a.clearTimeout(y)},cancelAll:f=>{for(const h in d._snapshot._scheduledEvents){const p=d._snapshot._scheduledEvents[h];p.source===f&&u.cancel(f,p.id)}}},l=f=>{if(!r.size)return;const h={...f,rootId:e.sessionId};r.forEach(p=>{var y;return(y=p.next)==null?void 0:y.call(p,h)})},d={_snapshot:{_scheduledEvents:((t==null?void 0:t.snapshot)&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${Jt++}`,_register:(f,h)=>(n.set(f,h),f),_unregister:f=>{n.delete(f.sessionId);const h=i.get(f);h!==void 0&&(s.delete(h),i.delete(f))},get:f=>s.get(f),_set:(f,h)=>{const p=s.get(f);if(p&&p!==h)throw new Error(`Actor with system ID '${f}' already exists.`);s.set(f,h),i.set(h,f)},inspect:f=>{const h=ve(f);return r.add(h),{unsubscribe(){r.delete(h)}}},_sendInspectionEvent:l,_relay:(f,h,p)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:f,actorRef:h,event:p}),h._send(p)},scheduler:u,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{const f=d._snapshot._scheduledEvents;d._snapshot._scheduledEvents={};for(const h in f){const{source:p,target:y,event:g,delay:S,id:b}=f[h];u.schedule(p,y,g,S,b)}},_clock:a,_logger:c};return d}let ue=!1;const Ee=1;let v=function(e){return e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped",e}({});const Wt={clock:{setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e)},logger:console.log.bind(console),devTools:!1};class Bt{constructor(t,n){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new qe(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=v.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const s={...Wt,...n},{clock:i,logger:r,parent:o,syncSnapshot:a,id:c,systemId:u,inspect:l}=s;this.system=o?o.system:Pt(this,{clock:i,logger:r}),l&&!o&&this.system.inspect(ve(l)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=(n==null?void 0:n.logger)??this.system._logger,this.clock=(n==null?void 0:n.clock)??this.system._clock,this._parent=o,this._syncSnapshot=a,this.options=s,this.src=s.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:d=>{this._deferred.push(d)},system:this.system,stopChild:d=>{if(d._parent!==this)throw new Error(`Cannot stop child actor ${d.id} of ${this.id} because it is not a child`);d._stop()},emit:d=>{const f=this.eventListeners.get(d.type),h=this.eventListeners.get("*");if(!f&&!h)return;const p=[...f?f.values():[],...h?h.values():[]];for(const y of p)y(d)},actionExecutor:d=>{const f=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:d.type,params:d.params}}),!d.exec)return;const h=ue;try{ue=!0,d.exec(d.info,d.params)}finally{ue=h}};this._processingStatus===v.Running?f():this._deferred.push(f)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),u&&(this._systemId=u,this.system._set(u,this)),this._initState((n==null?void 0:n.snapshot)??(n==null?void 0:n.state)),u&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){var n;try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,(n=this.options)==null?void 0:n.input)}catch(s){this._snapshot={status:"error",output:void 0,error:s}}}update(t,n){var i,r;this._snapshot=t;let s;for(;s=this._deferred.shift();)try{s()}catch(o){this._deferred.length=0,this._snapshot={...t,status:"error",error:o}}switch(this._snapshot.status){case"active":for(const o of this.observers)try{(i=o.next)==null||i.call(o,t)}catch(a){T(a)}break;case"done":for(const o of this.observers)try{(r=o.next)==null||r.call(o,t)}catch(a){T(a)}this._stopProcedure(),this._complete(),this._doneEvent=jt(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:n,snapshot:t})}subscribe(t,n,s){var r;const i=ve(t,n,s);if(this._processingStatus!==v.Stopped)this.observers.add(i);else switch(this._snapshot.status){case"done":try{(r=i.complete)==null||r.call(i)}catch(o){T(o)}break;case"error":{const o=this._snapshot.error;if(!i.error)T(o);else try{i.error(o)}catch(a){T(a)}break}}return{unsubscribe:()=>{this.observers.delete(i)}}}on(t,n){let s=this.eventListeners.get(t);s||(s=new Set,this.eventListeners.set(t,s));const i=n.bind(void 0);return s.add(i),{unsubscribe:()=>{s.delete(i)}}}start(){if(this._processingStatus===v.Running)return this;this._syncSnapshot&&this.subscribe({next:s=>{s.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:s})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=v.Running;const t=Qe(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(s){return this._snapshot={...this._snapshot,status:"error",error:s},this._error(s),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let n,s;try{n=this.logic.transition(this._snapshot,t,this._actorScope)}catch(i){s={err:i}}if(s){const{err:i}=s;this._snapshot={...this._snapshot,status:"error",error:i},this._error(i);return}this.update(n,t),t.type===G&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===v.Stopped?this:(this.mailbox.clear(),this._processingStatus===v.NotStarted?(this._processingStatus=v.Stopped,this):(this.mailbox.enqueue({type:G}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){var t;for(const n of this.observers)try{(t=n.complete)==null||t.call(n)}catch(s){T(s)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||T(t);return}let n=!1;for(const s of this.observers){const i=s.error;n||(n=!i);try{i==null||i(t)}catch(r){T(r)}}this.observers.clear(),n&&T(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,Ne(this.id,t))}_stopProcedure(){return this._processingStatus!==v.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new qe(this._process.bind(this)),this._processingStatus=v.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==v.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:$t)(this)}toJSON(){return{xstate$$type:Ee,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[Dt](){return this}getSnapshot(){return this._snapshot}}function C(e,...[t]){return new Bt(e,t)}function Gt(e,t,n,s,{sendId:i}){const r=typeof i=="function"?i(n,s):i;return[t,{sendId:r},void 0]}function zt(e,t){e.defer(()=>{e.system.scheduler.cancel(e.self,t.sendId)})}function it(e){function t(n,s){}return t.type="xstate.cancel",t.sendId=e,t.resolve=Gt,t.execute=zt,t}function Ht(e,t,n,s,{id:i,systemId:r,src:o,input:a,syncSnapshot:c}){const u=typeof o=="string"?xe(t.machine,o):o,l=typeof i=="function"?i(n):i;let d,f;return u&&(f=typeof a=="function"?a({context:t.context,event:n.event,self:e.self}):a,d=C(u,{id:l,src:o,parent:e.self,syncSnapshot:c,systemId:r,input:f})),[$(t,{children:{...t.children,[l]:d}}),{id:i,systemId:r,actorRef:d,src:o,input:f},void 0]}function Xt(e,{actorRef:t}){t&&e.defer(()=>{t._processingStatus!==v.Stopped&&t.start()})}function rt(...[e,{id:t,systemId:n,input:s,syncSnapshot:i=!1}={}]){function r(o,a){}return r.type="xstate.spawnChild",r.id=t,r.systemId=n,r.src=e,r.input=s,r.syncSnapshot=i,r.resolve=Ht,r.execute=Xt,r}function Kt(e,t,n,s,{actorRef:i}){const r=typeof i=="function"?i(n,s):i,o=typeof r=="string"?t.children[r]:r;let a=t.children;return o&&(a={...a},delete a[o.id]),[$(t,{children:a}),o,void 0]}function Yt(e,t){if(t){if(e.system._unregister(t),t._processingStatus!==v.Running){e.stopChild(t);return}e.defer(()=>{e.stopChild(t)})}}function ie(e){function t(n,s){}return t.type="xstate.stopChild",t.actorRef=e,t.resolve=Kt,t.execute=Yt,t}function re(e,t,n,s){const{machine:i}=s,r=typeof e=="function",o=r?e:i.implementations.guards[typeof e=="string"?e:e.type];if(!r&&!o)throw new Error(`Guard '${typeof e=="string"?e:e.type}' is not implemented.'.`);if(typeof o!="function")return re(o,t,n,s);const a={context:t,event:n},c=r||typeof e=="string"?void 0:"params"in e?typeof e.params=="function"?e.params({context:t,event:n}):e.params:void 0;return"check"in o?o.check(s,a,o):o(a,c)}const ke=e=>e.type==="atomic"||e.type==="final";function j(e){return Object.values(e.states).filter(t=>t.type!=="history")}function X(e,t){const n=[];if(t===e)return n;let s=e.parent;for(;s&&s!==t;)n.push(s),s=s.parent;return n}function Q(e){const t=new Set(e),n=at(t);for(const s of t)if(s.type==="compound"&&(!n.get(s)||!n.get(s).length))Ue(s).forEach(i=>t.add(i));else if(s.type==="parallel"){for(const i of j(s))if(i.type!=="history"&&!t.has(i)){const r=Ue(i);for(const o of r)t.add(o)}}for(const s of t){let i=s.parent;for(;i;)t.add(i),i=i.parent}return t}function ot(e,t){const n=t.get(e);if(!n)return{};if(e.type==="compound"){const i=n[0];if(i){if(ke(i))return i.key}else return{}}const s={};for(const i of n)s[i.key]=ot(i,t);return s}function at(e){const t=new Map;for(const n of e)t.has(n)||t.set(n,[]),n.parent&&(t.has(n.parent)||t.set(n.parent,[]),t.get(n.parent).push(n));return t}function ct(e,t){const n=Q(t);return ot(e,at(n))}function Ie(e,t){return t.type==="compound"?j(t).some(n=>n.type==="final"&&e.has(n)):t.type==="parallel"?j(t).every(n=>Ie(e,n)):t.type==="final"}const oe=e=>e[0]===Rt;function Ft(e,t){return e.transitions.get(t)||[...e.transitions.keys()].filter(s=>{if(s===Mt)return!0;if(!s.endsWith(".*"))return!1;const i=s.split("."),r=t.split(".");for(let o=0;o<i.length;o++){const a=i[o],c=r[o];if(a==="*")return o===i.length-1;if(a!==c)return!1}return!0}).sort((s,i)=>i.length-s.length).flatMap(s=>e.transitions.get(s))}function Vt(e){const t=e.config.after;if(!t)return[];const n=i=>{const r=Ct(i,e.id),o=r.type;return e.entry.push(P(r,{id:o,delay:i})),e.exit.push(it(o)),o};return Object.keys(t).flatMap(i=>{const r=t[i],o=typeof r=="string"?{target:r}:r,a=Number.isNaN(+i)?i:+i,c=n(a);return w(o).map(u=>({...u,event:c,delay:a}))}).map(i=>{const{delay:r}=i;return{...I(e,i.event,i),delay:r}})}function I(e,t,n){const s=st(n.target),i=n.reenter??!1,r=Qt(e,s),o={...n,actions:w(n.actions),guard:n.guard,target:r,source:e,reenter:i,eventType:t,toJSON:()=>({...o,source:`#${e.id}`,target:r?r.map(a=>`#${a.id}`):void 0})};return o}function Zt(e){const t=new Map;if(e.config.on)for(const n of Object.keys(e.config.on)){if(n===Ve)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const s=e.config.on[n];t.set(n,R(s).map(i=>I(e,n,i)))}if(e.config.onDone){const n=`xstate.done.state.${e.id}`;t.set(n,R(e.config.onDone).map(s=>I(e,n,s)))}for(const n of e.invoke){if(n.onDone){const s=`xstate.done.actor.${n.id}`;t.set(s,R(n.onDone).map(i=>I(e,s,i)))}if(n.onError){const s=`xstate.error.actor.${n.id}`;t.set(s,R(n.onError).map(i=>I(e,s,i)))}if(n.onSnapshot){const s=`xstate.snapshot.${n.id}`;t.set(s,R(n.onSnapshot).map(i=>I(e,s,i)))}}for(const n of e.after){let s=t.get(n.eventType);s||(s=[],t.set(n.eventType,s)),s.push(n)}return t}function Nt(e,t){const n=typeof t=="string"?e.states[t]:t?e.states[t.target]:void 0;if(!n&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${e.id}`);const s={source:e,actions:!t||typeof t=="string"?[]:w(t.actions),eventType:null,reenter:!1,target:n?[n]:[],toJSON:()=>({...s,source:`#${e.id}`,target:n?[`#${n.id}`]:[]})};return s}function Qt(e,t){if(t!==void 0)return t.map(n=>{if(typeof n!="string")return n;if(oe(n))return e.machine.getStateNodeById(n);const s=n[0]===Fe;if(s&&!e.parent)return ee(e,n.slice(1));const i=s?e.key+n:n;if(e.parent)try{return ee(e.parent,i)}catch(r){throw new Error(`Invalid transition definition for state node '${e.id}':
${r.message}`)}else throw new Error(`Invalid target: "${n}" is not a valid target from the root node. Did you mean ".${n}"?`)})}function ut(e){const t=st(e.config.target);return t?{target:t.map(n=>typeof n=="string"?ee(e.parent,n):n)}:e.parent.initial}function A(e){return e.type==="history"}function Ue(e){const t=dt(e);for(const n of t)for(const s of X(n,e))t.add(s);return t}function dt(e){const t=new Set;function n(s){if(!t.has(s)){if(t.add(s),s.type==="compound")n(s.initial.target[0]);else if(s.type==="parallel")for(const i of j(s))n(i)}}return n(e),t}function D(e,t){if(oe(t))return e.machine.getStateNodeById(t);if(!e.states)throw new Error(`Unable to retrieve child state '${t}' from '${e.id}'; no child states exist.`);const n=e.states[t];if(!n)throw new Error(`Child state '${t}' does not exist on '${e.id}'`);return n}function ee(e,t){if(typeof t=="string"&&oe(t))try{return e.machine.getStateNodeById(t)}catch{}const n=we(t).slice();let s=e;for(;n.length;){const i=n.shift();if(!i.length)break;s=D(s,i)}return s}function te(e,t){if(typeof t=="string"){const i=e.states[t];if(!i)throw new Error(`State '${t}' does not exist on '${e.id}'`);return[e,i]}const n=Object.keys(t),s=n.map(i=>D(e,i)).filter(Boolean);return[e.machine.root,e].concat(s,n.reduce((i,r)=>{const o=D(e,r);if(!o)return i;const a=te(o,t[r]);return i.concat(a)},[]))}function en(e,t,n,s){const r=D(e,t).next(n,s);return!r||!r.length?e.next(n,s):r}function tn(e,t,n,s){const i=Object.keys(t),r=D(e,i[0]),o=Ae(r,t[i[0]],n,s);return!o||!o.length?e.next(n,s):o}function nn(e,t,n,s){const i=[];for(const r of Object.keys(t)){const o=t[r];if(!o)continue;const a=D(e,r),c=Ae(a,o,n,s);c&&i.push(...c)}return i.length?i:e.next(n,s)}function Ae(e,t,n,s){return typeof t=="string"?en(e,t,n,s):Object.keys(t).length===1?tn(e,t,n,s):nn(e,t,n,s)}function sn(e){return Object.keys(e.states).map(t=>e.states[t]).filter(t=>t.type==="history")}function E(e,t){let n=e;for(;n.parent&&n.parent!==t;)n=n.parent;return n.parent===t}function rn(e,t){const n=new Set(e),s=new Set(t);for(const i of n)if(s.has(i))return!0;for(const i of s)if(n.has(i))return!0;return!1}function ft(e,t,n){const s=new Set;for(const i of e){let r=!1;const o=new Set;for(const a of s)if(rn(_e([i],t,n),_e([a],t,n)))if(E(i.source,a.source))o.add(a);else{r=!0;break}if(!r){for(const a of o)s.delete(a);s.add(i)}}return Array.from(s)}function on(e){const[t,...n]=e;for(const s of X(t,void 0))if(n.every(i=>E(i,s)))return s}function $e(e,t){if(!e.target)return[];const n=new Set;for(const s of e.target)if(A(s))if(t[s.id])for(const i of t[s.id])n.add(i);else for(const i of $e(ut(s),t))n.add(i);else n.add(s);return[...n]}function ht(e,t){const n=$e(e,t);if(!n)return;if(!e.reenter&&n.every(i=>i===e.source||E(i,e.source)))return e.source;const s=on(n.concat(e.source));if(s)return s;if(!e.reenter)return e.source.machine.root}function _e(e,t,n){var i;const s=new Set;for(const r of e)if((i=r.target)!=null&&i.length){const o=ht(r,n);r.reenter&&r.source===o&&s.add(o);for(const a of t)E(a,o)&&s.add(a)}return[...s]}function an(e,t){if(e.length!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function Se(e,t,n,s,i,r){if(!e.length)return t;const o=new Set(t._nodes);let a=t.historyValue;const c=ft(e,o,a);let u=t;i||([u,a]=fn(u,s,n,c,o,a,r,n.actionExecutor)),u=L(u,s,n,c.flatMap(d=>d.actions),r,void 0),u=un(u,s,n,c,o,r,a,i);const l=[...o];u.status==="done"&&(u=L(u,s,n,l.sort((d,f)=>f.order-d.order).flatMap(d=>d.exit),r,void 0));try{return a===t.historyValue&&an(t._nodes,o)?u:$(u,{_nodes:l,historyValue:a})}catch(d){throw d}}function cn(e,t,n,s,i){if(s.output===void 0)return;const r=ge(i.id,i.output!==void 0&&i.parent?me(i.output,e.context,t,n.self):void 0);return me(s.output,e.context,r,n.self)}function un(e,t,n,s,i,r,o,a){let c=e;const u=new Set,l=new Set;dn(s,o,l,u),a&&l.add(e.machine.root);const d=new Set;for(const f of[...u].sort((h,p)=>h.order-p.order)){i.add(f);const h=[];h.push(...f.entry);for(const p of f.invoke)h.push(rt(p.src,{...p,syncSnapshot:!!p.onSnapshot}));if(l.has(f)){const p=f.initial.actions;h.push(...p)}if(c=L(c,t,n,h,r,f.invoke.map(p=>p.id)),f.type==="final"){const p=f.parent;let y=(p==null?void 0:p.type)==="parallel"?p:p==null?void 0:p.parent,g=y||f;for((p==null?void 0:p.type)==="compound"&&r.push(ge(p.id,f.output!==void 0?me(f.output,c.context,t,n.self):void 0));(y==null?void 0:y.type)==="parallel"&&!d.has(y)&&Ie(i,y);)d.add(y),r.push(ge(y.id)),g=y,y=y.parent;if(y)continue;c=$(c,{status:"done",output:cn(c,t,n,c.machine.root,g)})}}return c}function dn(e,t,n,s){for(const i of e){const r=ht(i,t);for(const a of i.target||[])!A(a)&&(i.source!==a||i.source!==r||i.reenter)&&(s.add(a),n.add(a)),M(a,t,n,s);const o=$e(i,t);for(const a of o){const c=X(a,r);(r==null?void 0:r.type)==="parallel"&&c.push(r),lt(s,t,n,c,!i.source.parent&&i.reenter?void 0:r)}}}function M(e,t,n,s){var i;if(A(e))if(t[e.id]){const r=t[e.id];for(const o of r)s.add(o),M(o,t,n,s);for(const o of r)de(o,e.parent,s,t,n)}else{const r=ut(e);for(const o of r.target)s.add(o),r===((i=e.parent)==null?void 0:i.initial)&&n.add(e.parent),M(o,t,n,s);for(const o of r.target)de(o,e.parent,s,t,n)}else if(e.type==="compound"){const[r]=e.initial.target;A(r)||(s.add(r),n.add(r)),M(r,t,n,s),de(r,e,s,t,n)}else if(e.type==="parallel")for(const r of j(e).filter(o=>!A(o)))[...s].some(o=>E(o,r))||(A(r)||(s.add(r),n.add(r)),M(r,t,n,s))}function lt(e,t,n,s,i){for(const r of s)if((!i||E(r,i))&&e.add(r),r.type==="parallel")for(const o of j(r).filter(a=>!A(a)))[...e].some(a=>E(a,o))||(e.add(o),M(o,t,n,e))}function de(e,t,n,s,i){lt(n,s,i,X(e,t))}function fn(e,t,n,s,i,r,o,a){let c=e;const u=_e(s,i,r);u.sort((d,f)=>f.order-d.order);let l;for(const d of u)for(const f of sn(d)){let h;f.history==="deep"?h=p=>ke(p)&&E(p,d):h=p=>p.parent===d,l??(l={...r}),l[f.id]=Array.from(i).filter(h)}for(const d of u)c=L(c,t,n,[...d.exit,...d.invoke.map(f=>ie(f.id))],o,void 0),i.delete(d);return[c,l||r]}function hn(e,t){return e.implementations.actions[t]}function pt(e,t,n,s,i,r){const{machine:o}=e;let a=e;for(const c of s){const u=typeof c=="function",l=u?c:hn(o,typeof c=="string"?c:c.type),d={context:a.context,event:t,self:n.self,system:n.system},f=u||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:t}):c.params:void 0;if(!l||!("resolve"in l)){n.actionExecutor({type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",info:d,params:f,exec:l});continue}const h=l,[p,y,g]=h.resolve(n,a,d,f,l,i);a=p,"retryResolve"in h&&(r==null||r.push([h,y])),"execute"in h&&n.actionExecutor({type:h.type,info:d,params:y,exec:h.execute.bind(null,n,y)}),g&&(a=pt(a,t,n,g,i,r))}return a}function L(e,t,n,s,i,r){const o=r?[]:void 0,a=pt(e,t,n,s,{internalQueue:i,deferredActorIds:r},o);return o==null||o.forEach(([c,u])=>{c.retryResolve(n,a,u)}),a}function fe(e,t,n,s){let i=e;const r=[];function o(u,l,d){n.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:n.self,event:l,snapshot:u,_transitions:d}),r.push(u)}if(t.type===G)return i=$(Je(i,t,n),{status:"stopped"}),o(i,t,[]),{snapshot:i,microstates:r};let a=t;if(a.type!==Ze){const u=a,l=Ut(u),d=Pe(u,i);if(l&&!d.length)return i=$(e,{status:"error",error:u.error}),o(i,u,[]),{snapshot:i,microstates:r};i=Se(d,e,n,a,!1,s),o(i,u,d)}let c=!0;for(;i.status==="active";){let u=c?ln(i,a):[];const l=u.length?i:void 0;if(!u.length){if(!s.length)break;a=s.shift(),u=Pe(a,i)}i=Se(u,i,n,a,!1,s),c=i!==l,o(i,a,u)}return i.status!=="active"&&Je(i,a,n),{snapshot:i,microstates:r}}function Je(e,t,n){return L(e,t,n,Object.values(e.children).map(s=>ie(s)),[],void 0)}function Pe(e,t){return t.machine.getTransitionData(t,e)}function ln(e,t){const n=new Set,s=e._nodes.filter(ke);for(const i of s)e:for(const r of[i].concat(X(i,void 0)))if(r.always){for(const o of r.always)if(o.guard===void 0||re(o.guard,e.context,t,e)){n.add(o);break e}}return ft(Array.from(n),new Set(e._nodes),e.historyValue)}function pn(e,t){const n=Q(te(e,t));return ct(e,[...n])}function yn(e){return!!e&&typeof e=="object"&&"machine"in e&&"value"in e}const gn=function(t){return et(t,this.value)},mn=function(t){return this.tags.has(t)},vn=function(t){const n=this.machine.getTransitionData(this,t);return!!(n!=null&&n.length)&&n.some(s=>s.target!==void 0||s.actions.length)},_n=function(){const{_nodes:t,tags:n,machine:s,getMeta:i,toJSON:r,can:o,hasTag:a,matches:c,...u}=this;return{...u,tags:Array.from(n)}},Sn=function(){return this._nodes.reduce((t,n)=>(n.meta!==void 0&&(t[n.id]=n.meta),t),{})};function V(e,t){return{status:e.status,output:e.output,error:e.error,machine:t,context:e.context,_nodes:e._nodes,value:ct(t.root,e._nodes),tags:new Set(e._nodes.flatMap(n=>n.tags)),children:e.children,historyValue:e.historyValue||{},matches:gn,hasTag:mn,can:vn,getMeta:Sn,toJSON:_n}}function $(e,t={}){return V({...e,...t},e.machine)}function bn(e,t){const{_nodes:n,tags:s,machine:i,children:r,context:o,can:a,hasTag:c,matches:u,getMeta:l,toJSON:d,...f}=e,h={};for(const y in r){const g=r[y];h[y]={snapshot:g.getPersistedSnapshot(t),src:g.src,systemId:g._systemId,syncSnapshot:g._syncSnapshot}}return{...f,context:yt(o),children:h}}function yt(e){let t;for(const n in e){const s=e[n];if(s&&typeof s=="object")if("sessionId"in s&&"send"in s&&"ref"in s)t??(t=Array.isArray(e)?e.slice():{...e}),t[n]={xstate$$type:Ee,id:s.id};else{const i=yt(s);i!==s&&(t??(t=Array.isArray(e)?e.slice():{...e}),t[n]=i)}}return t??e}function Tn(e,t,n,s,{event:i,id:r,delay:o},{internalQueue:a}){const c=t.machine.implementations.delays;if(typeof i=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${i}" }) instead`);const u=typeof i=="function"?i(n,s):i;let l;if(typeof o=="string"){const d=c&&c[o];l=typeof d=="function"?d(n,s):d}else l=typeof o=="function"?o(n,s):o;return typeof l!="number"&&a.push(u),[t,{event:u,id:r,delay:l},void 0]}function wn(e,t){const{event:n,delay:s,id:i}=t;if(typeof s=="number"){e.defer(()=>{const r=e.self;e.system.scheduler.schedule(r,r,n,s,i)});return}}function P(e,t){function n(s,i){}return n.type="xstate.raise",n.event=e,n.id=t==null?void 0:t.id,n.delay=t==null?void 0:t.delay,n.resolve=Tn,n.execute=wn,n}function xn(e,t){return{config:e,transition:(n,s,i)=>({...n,context:e(n.context,s,i)}),getInitialSnapshot:(n,s)=>({status:"active",output:void 0,error:void 0,context:typeof t=="function"?t({input:s}):t}),getPersistedSnapshot:n=>n,restoreSnapshot:n=>n}}const We="xstate.observable.error",Be="xstate.observable.complete";function gt(e){return{config:e,transition:(n,s)=>{if(n.status!=="active")return n;switch(s.type){case We:return{...n,status:"error",error:s.data,input:void 0,_subscription:void 0};case Be:return{...n,status:"done",input:void 0,_subscription:void 0};case G:return n._subscription.unsubscribe(),{...n,status:"stopped",input:void 0,_subscription:void 0};default:return n}},getInitialSnapshot:(n,s)=>({status:"active",output:void 0,error:void 0,context:void 0,input:s,_subscription:void 0}),start:(n,{self:s,system:i,emit:r})=>{n.status!=="done"&&(n._subscription=e({input:n.input,system:i,self:s,emit:r}).subscribe({next:o=>{s._parent&&i._relay(s,s._parent,o)},error:o=>{i._relay(s,s,{type:We,data:o})},complete:()=>{i._relay(s,s,{type:Be})}}))},getPersistedSnapshot:({_subscription:n,...s})=>s,restoreSnapshot:n=>({...n,_subscription:void 0})}}const Ge="xstate.promise.resolve",ze="xstate.promise.reject",K=new WeakMap;function hs(e){return{config:e,transition:(n,s,i)=>{var r;if(n.status!=="active")return n;switch(s.type){case Ge:{const o=s.data;return{...n,status:"done",output:o,input:void 0}}case ze:return{...n,status:"error",error:s.data,input:void 0};case G:return(r=K.get(i.self))==null||r.abort(),{...n,status:"stopped",input:void 0};default:return n}},start:(n,{self:s,system:i,emit:r})=>{if(n.status!=="active")return;const o=new AbortController;K.set(s,o),Promise.resolve(e({input:n.input,system:i,self:s,signal:o.signal,emit:r})).then(c=>{s.getSnapshot().status==="active"&&(K.delete(s),i._relay(s,s,{type:Ge,data:c}))},c=>{s.getSnapshot().status==="active"&&(K.delete(s),i._relay(s,s,{type:ze,data:c}))})},getInitialSnapshot:(n,s)=>({status:"active",output:void 0,error:void 0,input:s}),getPersistedSnapshot:n=>n,restoreSnapshot:n=>n}}const En=xn(e=>{},void 0);function ls(){return C(En)}function kn(e,{machine:t,context:n},s,i){const r=(o,a={})=>{const{systemId:c,input:u}=a;if(typeof o=="string"){const l=xe(t,o);if(!l)throw new Error(`Actor logic '${o}' not implemented in machine '${t.id}'`);const d=C(l,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:typeof u=="function"?u({context:n,event:s,self:e.self}):u,src:o,systemId:c});return i[d.id]=d,d}else return C(o,{id:a.id,parent:e.self,syncSnapshot:a.syncSnapshot,input:a.input,src:o,systemId:c})};return(o,a)=>{const c=r(o,a);return i[c.id]=c,e.defer(()=>{c._processingStatus!==v.Stopped&&c.start()}),c}}function In(e,t,n,s,{assignment:i}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const r={},o={context:t.context,event:n.event,spawn:kn(e,t,n.event,r),self:e.self,system:e.system};let a={};if(typeof i=="function")a=i(o,s);else for(const u of Object.keys(i)){const l=i[u];a[u]=typeof l=="function"?l(o,s):l}const c=Object.assign({},t.context,a);return[$(t,{context:c,children:Object.keys(r).length?{...t.children,...r}:t.children}),void 0,void 0]}function q(e){function t(n,s){}return t.type="xstate.assign",t.assignment=e,t.resolve=In,t}function An(e,t,n,s,{event:i}){const r=typeof i=="function"?i(n,s):i;return[t,{event:r},void 0]}function $n(e,{event:t}){e.defer(()=>e.emit(t))}function mt(e){function t(n,s){}return t.type="xstate.emit",t.event=e,t.resolve=An,t.execute=$n,t}let be=function(e){return e.Parent="#_parent",e.Internal="#_internal",e}({});function On(e,t,n,s,{to:i,event:r,id:o,delay:a},c){var p;const u=t.machine.implementations.delays;if(typeof r=="string")throw new Error(`Only event objects may be used with sendTo; use sendTo({ type: "${r}" }) instead`);const l=typeof r=="function"?r(n,s):r;let d;if(typeof a=="string"){const y=u&&u[a];d=typeof y=="function"?y(n,s):y}else d=typeof a=="function"?a(n,s):a;const f=typeof i=="function"?i(n,s):i;let h;if(typeof f=="string"){if(f===be.Parent?h=e.self._parent:f===be.Internal?h=e.self:f.startsWith("#_")?h=t.children[f.slice(2)]:h=(p=c.deferredActorIds)!=null&&p.includes(f)?f:t.children[f],!h)throw new Error(`Unable to send event to actor '${f}' from machine '${t.machine.id}'.`)}else h=f||e.self;return[t,{to:h,targetId:typeof f=="string"?f:void 0,event:l,id:o,delay:d},void 0]}function Rn(e,t,n){typeof n.to=="string"&&(n.to=t.children[n.to])}function Mn(e,t){e.defer(()=>{const{to:n,event:s,delay:i,id:r}=t;if(typeof i=="number"){e.system.scheduler.schedule(e.self,n,s,i,r);return}e.system._relay(e.self,n,s.type===qt?Ne(e.self.id,s.data):s)})}function W(e,t,n){function s(i,r){}return s.type="xstate.sendTo",s.to=e,s.event=t,s.id=n==null?void 0:n.id,s.delay=n==null?void 0:n.delay,s.resolve=On,s.retryResolve=Rn,s.execute=Mn,s}function qn(e,t){return W(be.Parent,e,t)}function Cn(e,t,n,s,{collect:i}){const r=[],o=function(c){r.push(c)};return o.assign=(...a)=>{r.push(q(...a))},o.cancel=(...a)=>{r.push(it(...a))},o.raise=(...a)=>{r.push(P(...a))},o.sendTo=(...a)=>{r.push(W(...a))},o.sendParent=(...a)=>{r.push(qn(...a))},o.spawnChild=(...a)=>{r.push(rt(...a))},o.stopChild=(...a)=>{r.push(ie(...a))},o.emit=(...a)=>{r.push(mt(...a))},i({context:n.context,event:n.event,enqueue:o,check:a=>re(a,t.context,n.event,t),self:e.self,system:e.system},s),[t,void 0,r]}function U(e){function t(n,s){}return t.type="xstate.enqueueActions",t.collect=e,t.resolve=Cn,t}function _(e,t){const n=w(t);if(!n.includes(e.type)){const s=n.length===1?`type "${n[0]}"`:`one of types "${n.join('", "')}"`;throw new Error(`Expected event ${JSON.stringify(e)} to have ${s}`)}}const He=new WeakMap;function O(e,t,n){let s=He.get(e);return s?t in s||(s[t]=n()):(s={[t]:n()},He.set(e,s)),s[t]}const jn={},J=e=>typeof e=="string"?{type:e}:typeof e=="function"?"resolve"in e?{type:e.type}:{type:e.name}:e;class Oe{constructor(t,n){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=n._parent,this.key=n._key,this.machine=n._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(Fe),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?je(this.config.states,(s,i)=>new Oe(s,{_parent:this,_key:i,_machine:this.machine})):jn,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=w(this.config.entry).slice(),this.exit=w(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=w(t.tags).slice()}_initialize(){this.transitions=Zt(this),this.config.always&&(this.always=R(this.config.always).map(t=>I(this,Ve,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(J),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(J),eventType:null})}:void 0,history:this.history,states:je(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(J)})),entry:this.entry.map(J),exit:this.exit.map(J),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return O(this,"invoke",()=>w(this.config.invoke).map((t,n)=>{const{src:s,systemId:i}=t,r=t.id??De(this.id,n),o=typeof s=="string"?s:`xstate.invoke.${De(this.id,n)}`;return{...t,src:o,id:r,systemId:i,toJSON(){const{onDone:a,onError:c,...u}=t;return{...u,type:"xstate.invoke",src:o,id:r}}}}))}get on(){return O(this,"on",()=>[...this.transitions].flatMap(([n,s])=>s.map(i=>[n,i])).reduce((n,[s,i])=>(n[s]=n[s]||[],n[s].push(i),n),{}))}get after(){return O(this,"delayedTransitions",()=>Vt(this))}get initial(){return O(this,"initial",()=>Nt(this,this.config.initial))}next(t,n){const s=n.type,i=[];let r;const o=O(this,`candidates-${s}`,()=>Ft(this,s));for(const a of o){const{guard:c}=a,u=t.context;let l=!1;try{l=!c||re(c,u,n,t)}catch(d){const f=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${f?`'${f}' `:""}in transition for event '${s}' in state node '${this.id}':
${d.message}`)}if(l){i.push(...a.actions),r=a;break}}return r?[r]:void 0}get events(){return O(this,"events",()=>{const{states:t}=this,n=new Set(this.ownEvents);if(t)for(const s of Object.keys(t)){const i=t[s];if(i.states)for(const r of i.events)n.add(`${r}`)}return Array.from(n)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(n=>this.transitions.get(n).some(s=>!(!s.target&&!s.actions.length&&!s.reenter))));return Array.from(t)}}const Dn="#";class Re{constructor(t,n){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=t.id||"(machine)",this.implementations={actors:(n==null?void 0:n.actors)??{},actions:(n==null?void 0:n.actions)??{},delays:(n==null?void 0:n.delays)??{},guards:(n==null?void 0:n.guards)??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new Oe(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:n,guards:s,actors:i,delays:r}=this.implementations;return new Re(this.config,{actions:{...n,...t.actions},guards:{...s,...t.guards},actors:{...i,...t.actors},delays:{...r,...t.delays}})}resolveState(t){const n=pn(this.root,t.value),s=Q(te(this.root,n));return V({_nodes:[...s],context:t.context||{},children:{},status:Ie(s,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,n,s){return fe(t,n,s,[]).snapshot}microstep(t,n,s){return fe(t,n,s,[]).microstates}getTransitionData(t,n){return Ae(this.root,t.value,t,n)||[]}getPreInitialState(t,n,s){const{context:i}=this.config,r=V({context:typeof i!="function"&&i?i:{},_nodes:[this.root],children:{},status:"active"},this);return typeof i=="function"?L(r,n,t,[q(({spawn:a,event:c,self:u})=>i({spawn:a,input:c.input,self:u}))],s,void 0):r}getInitialSnapshot(t,n){const s=Qe(n),i=[],r=this.getPreInitialState(t,s,i),o=Se([{target:[...dt(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],r,t,s,!0,i),{snapshot:a}=fe(o,s,t,i);return a}start(t){Object.values(t.children).forEach(n=>{n.getSnapshot().status==="active"&&n.start()})}getStateNodeById(t){const n=we(t),s=n.slice(1),i=oe(n[0])?n[0].slice(Dn.length):n[0],r=this.idMap.get(i);if(!r)throw new Error(`Child state node '#${i}' does not exist on machine '${this.id}'`);return ee(r,s)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,n){return bn(t,n)}restoreSnapshot(t,n){const s={},i=t.children;Object.keys(i).forEach(c=>{const u=i[c],l=u.snapshot,d=u.src,f=typeof d=="string"?xe(this,d):d;if(!f)return;const h=C(f,{id:c,parent:n.self,syncSnapshot:u.syncSnapshot,snapshot:l,src:d,systemId:u.systemId});s[c]=h});const r=V({...t,children:s,_nodes:Array.from(Q(te(this.root,t.value)))},this),o=new Set;function a(c,u){if(!o.has(c)){o.add(c);for(const l in c){const d=c[l];if(d&&typeof d=="object"){if("xstate$$type"in d&&d.xstate$$type===Ee){c[l]=u[d.id];continue}a(d,u)}}}}return a(r.context,s),r}}function Ln(e,t){return new Re(e,t)}function vt({schemas:e,actors:t,actions:n,guards:s,delays:i}){return{createMachine:r=>Ln({...r,schemas:e},{actors:t,actions:n,guards:s,delays:i})}}var _t=new Te(function(e){return e.complete()});function Un(e,t,n,s,i,r,o,a){var c=[],u=0,l=0,d=!1,f=function(){d&&!c.length&&!u&&t.complete()},h=function(y){return u<s?p(y):c.push(y)},p=function(y){u++;var g=!1;H(n(y,l++)).subscribe(B(t,function(S){t.next(S)},function(){g=!0},void 0,function(){if(g)try{u--;for(var S=function(){var b=c.shift();o||p(b)};c.length&&u<s;)S();f()}catch(b){t.error(b)}}))};return e.subscribe(B(t,h,function(){d=!0,f()})),function(){}}function ne(e,t,n){return n===void 0&&(n=1/0),x(t)?ne(function(s,i){return N(function(r,o){return t(s,r,i,o)})(H(e(s,i)))},n):(typeof t=="number"&&(n=t),se(function(s,i){return Un(s,i,e,n)}))}function Jn(e){return new Te(function(t){H(e()).subscribe(t)})}var Pn=["addListener","removeListener"],Wn=["addEventListener","removeEventListener"],Bn=["on","off"];function z(e,t,n,s){if(x(n)&&(s=n,n=void 0),s)return z(e,t,n).pipe(Tt(s));var i=wt(Hn(e)?Wn.map(function(a){return function(c){return e[a](t,c,n)}}):Gn(e)?Pn.map(Xe(e,t)):zn(e)?Bn.map(Xe(e,t)):[],2),r=i[0],o=i[1];if(!r&&xt(e))return ne(function(a){return z(a,t,n)})(H(e));if(!r)throw new TypeError("Invalid event target");return new Te(function(a){var c=function(){for(var u=[],l=0;l<arguments.length;l++)u[l]=arguments[l];return a.next(1<u.length?u:u[0])};return r(c),function(){return o(c)}})}function Xe(e,t){return function(n){return function(s){return e[n](t,s)}}}function Gn(e){return x(e.addListener)&&x(e.removeListener)}function zn(e){return x(e.on)&&x(e.off)}function Hn(e){return x(e.addEventListener)&&x(e.removeEventListener)}function Xn(e,t){return t===void 0&&(t=null),t=t??e,se(function(n,s){var i=[],r=0;n.subscribe(B(s,function(o){var a,c,u,l,d=null;r++%t===0&&i.push([]);try{for(var f=ae(i),h=f.next();!h.done;h=f.next()){var p=h.value;p.push(o),e<=p.length&&(d=d??[],d.push(p))}}catch(S){a={error:S}}finally{try{h&&!h.done&&(c=f.return)&&c.call(f)}finally{if(a)throw a.error}}if(d)try{for(var y=ae(d),g=y.next();!g.done;g=y.next()){var p=g.value;Et(i,p),s.next(p)}}catch(S){u={error:S}}finally{try{g&&!g.done&&(l=y.return)&&l.call(y)}finally{if(u)throw u.error}}},function(){var o,a;try{for(var c=ae(i),u=c.next();!u.done;u=c.next()){var l=u.value;s.next(l)}}catch(d){o={error:d}}finally{try{u&&!u.done&&(a=c.return)&&a.call(c)}finally{if(o)throw o.error}}s.complete()},void 0,function(){i=null}))})}function Kn(e,t){return x(t)?ne(e,t,1):ne(e,1)}function Me(e){return e<=0?function(){return _t}:se(function(t,n){var s=0;t.subscribe(B(n,function(i){++s<=e&&(n.next(i),e<=s&&n.complete())}))})}function Yn(e){return se(function(t,n){H(e).subscribe(B(n,function(){return n.complete()},kt)),!n.closed&&t.subscribe(n)})}var m=[];for(var he=0;he<256;++he)m.push((he+256).toString(16).slice(1));function Fn(e,t=0){return(m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+"-"+m[e[t+4]]+m[e[t+5]]+"-"+m[e[t+6]]+m[e[t+7]]+"-"+m[e[t+8]]+m[e[t+9]]+"-"+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]).toLowerCase()}var Y,Vn=new Uint8Array(16);function Zn(){if(!Y&&(Y=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Y))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Y(Vn)}var Nn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Ke={randomUUID:Nn};function St(e,t,n){if(Ke.randomUUID&&!t&&!e)return Ke.randomUUID();e=e||{};var s=e.random||(e.rng||Zn)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Fn(s)}const k=e=>({context:t})=>{const{count:n,include:s,exclude:i,responseType:r="message.received"}=e;return{count:n,domain:t.domain,from:t.connectTo,include:s?Array.isArray(s)?s:[s]:[],exclude:i?Array.isArray(i)?i:[i]:[],responseType:r,target:t.target,to:t.name}},Qn=e=>t=>{const{data:n}=t;return(e.include.length?e.include.includes(n.type):!0)&&(e.exclude.length?!e.exclude.includes(n.type):!0)&&n.domain===e.domain&&n.from===e.from&&n.to===e.to&&(!e.target||t.source===e.target)},es=e=>t=>({type:e,message:t}),ts=Jn(()=>z(window,"message")),ns=e=>gt(({input:t})=>ts.pipe(e?N(e):ce(),Ye(Qn(t)),N(es(t.responseType)),t.count?ce(Xn(t.count),Kn(n=>n),Me(t.count)):ce())),ss="sanity/comlink",is=3e3,rs=1e4,Z="comlink/response",le="comlink/heartbeat",F="comlink/disconnect",pe="comlink/handshake/syn",os="comlink/handshake/syn-ack",ye="comlink/handshake/ack",as=e=>t=>t.pipe(Me(1),N(()=>{throw new Error(e)})),cs=()=>vt({actors:{listen:gt(({input:e})=>{const t=e.signal?z(e.signal,"abort").pipe(as(`Request ${e.requestId} aborted`)):_t,n=s=>{var i,r;return((i=s.data)==null?void 0:i.type)===Z&&((r=s.data)==null?void 0:r.responseTo)===e.requestId&&!!s.source&&e.sources.has(s.source)};return z(window,"message").pipe(Ye(n),Me(e.sources.size),Yn(t))})},actions:{"send message":({context:e},t)=>{const{sources:n,targetOrigin:s}=e,{message:i}=t;n.forEach(r=>{r.postMessage(i,{targetOrigin:s})})},"on success":W(({context:e})=>e.parentRef,({context:e,self:t})=>{var n;return e.response&&((n=e.resolvable)==null||n.resolve(e.response)),{type:"request.success",requestId:t.id,response:e.response,responseTo:e.responseTo}}),"on fail":W(({context:e})=>e.parentRef,({context:e,self:t})=>{var n;return e.suppressWarnings||console.warn(`[@sanity/comlink] Received no response to message '${e.type}' on client '${e.from}' (ID: '${e.id}').`),(n=e.resolvable)==null||n.reject(new Error("No response received")),{type:"request.failed",requestId:t.id}}),"on abort":W(({context:e})=>e.parentRef,({context:e,self:t})=>{var n;return(n=e.resolvable)==null||n.reject(new Error("Request aborted")),{type:"request.aborted",requestId:t.id}})},guards:{expectsResponse:({context:e})=>e.expectResponse},delays:{initialTimeout:0,responseTimeout:({context:e})=>e.responseTimeout??is}}).createMachine({context:({input:e})=>({connectionId:e.connectionId,data:e.data,domain:e.domain,expectResponse:e.expectResponse??!1,from:e.from,id:`msg-${St()}`,parentRef:e.parentRef,resolvable:e.resolvable,response:null,responseTimeout:e.responseTimeout,responseTo:e.responseTo,signal:e.signal,sources:e.sources instanceof Set?e.sources:new Set([e.sources]),suppressWarnings:e.suppressWarnings,targetOrigin:e.targetOrigin,to:e.to,type:e.type}),initial:"idle",on:{abort:".aborted"},states:{idle:{after:{initialTimeout:[{target:"sending"}]}},sending:{entry:{type:"send message",params:({context:e})=>{const{connectionId:t,data:n,domain:s,from:i,id:r,responseTo:o,to:a,type:c}=e;return{message:{connectionId:t,data:n,domain:s,from:i,id:r,to:a,type:c,responseTo:o}}}},always:[{guard:"expectsResponse",target:"awaiting"},"success"]},awaiting:{invoke:{id:"listen for response",src:"listen",input:({context:e})=>({requestId:e.id,sources:e.sources,signal:e.signal}),onError:"aborted"},after:{responseTimeout:"failed"},on:{message:{actions:q({response:({event:e})=>e.data.data,responseTo:({event:e})=>e.data.responseTo}),target:"success"}}},failed:{type:"final",entry:"on fail"},success:{type:"final",entry:"on success"},aborted:{type:"final",entry:"on abort"}},output:({context:e,self:t})=>({requestId:t.id,response:e.response,responseTo:e.responseTo})}),us=()=>vt({actors:{requestMachine:cs(),listen:ns()},actions:{"buffer incoming message":q({handshakeBuffer:({event:e,context:t})=>(_(e,"message.received"),[...t.handshakeBuffer,e])}),"buffer message":U(({enqueue:e})=>{e.assign({buffer:({event:t,context:n})=>(_(t,"post"),[...n.buffer,{data:t.data,resolvable:t.resolvable,options:t.options}])}),e.emit(({event:t})=>(_(t,"post"),{type:"_buffer.added",message:t.data}))}),"create request":q({requests:({context:e,event:t,self:n,spawn:s})=>{_(t,"request");const i=(Array.isArray(t.data)?t.data:[t.data]).map(r=>{var a,c,u;const o=`req-${St()}`;return s("requestMachine",{id:o,input:{connectionId:e.connectionId,data:r.data,domain:e.domain,expectResponse:r.expectResponse,from:e.name,parentRef:n,resolvable:r.resolvable,responseTimeout:(a=r.options)==null?void 0:a.responseTimeout,responseTo:r.responseTo,signal:(c=r.options)==null?void 0:c.signal,sources:e.target,suppressWarnings:(u=r.options)==null?void 0:u.suppressWarnings,targetOrigin:e.targetOrigin,to:e.connectTo,type:r.type}})});return[...e.requests,...i]}}),"emit heartbeat":mt(()=>({type:"_heartbeat"})),"emit received message":U(({enqueue:e})=>{e.emit(({event:t})=>(_(t,"message.received"),{type:"_message",message:t.message.data})),e.emit(({event:t})=>(_(t,"message.received"),{type:t.message.data.type,message:t.message.data}))}),"flush buffer":U(({enqueue:e})=>{e.raise(({context:t})=>({type:"request",data:t.buffer.map(({data:n,resolvable:s,options:i})=>({data:n.data,type:n.type,expectResponse:!!s,resolvable:s,options:i}))})),e.emit(({context:t})=>({type:"_buffer.flushed",messages:t.buffer.map(({data:n})=>n)})),e.assign({buffer:[]})}),"flush handshake buffer":U(({context:e,enqueue:t})=>{e.handshakeBuffer.forEach(n=>t.raise(n)),t.assign({handshakeBuffer:[]})}),post:P(({event:e})=>(_(e,"post"),{type:"request",data:{data:e.data.data,expectResponse:!!e.resolvable,type:e.data.type,resolvable:e.resolvable,options:e.options}})),"remove request":U(({context:e,enqueue:t,event:n})=>{_(n,["request.success","request.failed","request.aborted"]),ie(n.requestId),t.assign({requests:e.requests.filter(({id:s})=>s!==n.requestId)})}),"send response":P(({event:e})=>(_(e,["message.received","heartbeat.received"]),{type:"request",data:{type:Z,responseTo:e.message.data.id,data:void 0}})),"send handshake syn ack":P({type:"request",data:{type:os}}),"set connection config":q({connectionId:({event:e})=>(_(e,"handshake.syn"),e.message.data.connectionId),target:({event:e})=>(_(e,"handshake.syn"),e.message.source||void 0),targetOrigin:({event:e})=>(_(e,"handshake.syn"),e.message.origin)})},guards:{hasSource:({context:e})=>e.target!==null}}).createMachine({id:"node",context:({input:e})=>({buffer:[],connectionId:null,connectTo:e.connectTo,domain:e.domain??ss,handshakeBuffer:[],name:e.name,requests:[],target:void 0,targetOrigin:null}),invoke:{id:"listen for handshake syn",src:"listen",input:k({include:pe,responseType:"handshake.syn"})},on:{"request.success":{actions:"remove request"},"request.failed":{actions:"remove request"},"request.aborted":{actions:"remove request"},"handshake.syn":{actions:"set connection config",target:".handshaking"}},initial:"idle",states:{idle:{on:{post:{actions:"buffer message"}}},handshaking:{guard:"hasSource",entry:"send handshake syn ack",invoke:[{id:"listen for handshake ack",src:"listen",input:k({include:ye,count:1,responseType:"handshake.complete"}),onDone:"connected"},{id:"listen for disconnect",src:"listen",input:k({include:F,count:1,responseType:"disconnect"})},{id:"listen for messages",src:"listen",input:k({exclude:[F,pe,ye,le,Z]})}],on:{request:{actions:"create request"},post:{actions:"buffer message"},"message.received":{actions:"buffer incoming message"},disconnect:{target:"idle"}}},connected:{entry:["flush handshake buffer","flush buffer"],invoke:[{id:"listen for messages",src:"listen",input:k({exclude:[F,pe,ye,le,Z]})},{id:"listen for heartbeat",src:"listen",input:k({include:le,responseType:"heartbeat.received"})},{id:"listen for disconnect",src:"listen",input:k({include:F,count:1,responseType:"disconnect"})}],on:{request:{actions:"create request"},post:{actions:"post"},disconnect:{target:"idle"},"message.received":{actions:["send response","emit received message"]},"heartbeat.received":{actions:["send response","emit heartbeat"]}}}}}),ps=(e,t=us())=>{const n=C(t,{input:e}),s=(c,u)=>{const{unsubscribe:l}=n.on(c,d=>{u(d.message.data)});return l},i=c=>{const u=n.getSnapshot();let l=typeof u.value=="string"?u.value:Object.keys(u.value)[0];const{unsubscribe:d}=n.subscribe(f=>{const h=typeof f.value=="string"?f.value:Object.keys(f.value)[0];l!==h&&(l=h,c(h))});return d},r=c=>{n.send({type:"post",data:c})},o=(c,u)=>{const{responseTimeout:l=rs,signal:d,suppressWarnings:f}=u||{},h=Promise.withResolvers();return n.send({type:"post",data:c,resolvable:h,options:{responseTimeout:l,signal:d,suppressWarnings:f}}),h.promise},a=()=>{n.stop()};return{actor:n,fetch:o,machine:t,on:s,onStatus:i,post:r,start:()=>(n.start(),a),stop:a}};export{ss as D,_t as E,F as M,le as a,Z as b,cs as c,ye as d,os as e,pe as f,ns as g,ps as h,us as i,hs as j,gt as k,Jn as l,ne as m,qn as n,_ as o,U as p,q,ie as r,vt as s,rt as t,P as u,mt as v,ls as w,C as x};
